<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Labirinto delle Tubature</title>

  <style>
    :root {
      --accent: #22d3ee;
      --danger: #ef4444;
      --ok: #22c55e;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, Arial, sans-serif;
      background: radial-gradient(circle at top, #020617, #020617 40%, #000);
      color: #e5e7eb;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .container {
      width: 100%;
      max-width: 520px;
      padding: 16px;
      text-align: center;
    }

    h1 {
      margin: 8px 0 4px;
      font-size: 1.4rem;
      letter-spacing: .5px;
    }

    .subtitle {
      opacity: .7;
      font-size: .9rem;
      margin-bottom: 10px;
    }

    .scelte button {
      background: #0b1220;
      color: #e5e7eb;
      border: 1px solid #1f2933;
      border-radius: 10px;
      padding: 10px 14px;
      font-size: 1rem;
      cursor: pointer;
    }

    .scelte button:active { transform: scale(.97); }

    .hud {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 10px 0 6px;
      font-size: .95rem;
    }

    .timer-wrap {
      width: 100%;
      background: #020617;
      border: 1px solid #0b1220;
      border-radius: 999px;
      overflow: hidden;
      height: 10px;
      margin: 8px 0 14px;
    }

    .timer-bar {
      height: 100%;
      width: 100%;
      background: linear-gradient(90deg, var(--accent), #38bdf8);
      transition: width 1s linear;
    }

    .tubi {
      display: flex;
      justify-content: center;
      gap: 18px;
      margin-top: 16px;
    }

    .tubo {
      width: 64px;
      height: 190px;
      border-radius: 999px;
      background: linear-gradient(180deg, #9ca3af, #4b5563);
      position: relative;
      overflow: hidden;
      cursor: pointer;
      box-shadow: inset 0 0 0 2px rgba(0,0,0,.35), 0 10px 25px rgba(0,0,0,.4);
      transition: transform .12s ease, box-shadow .12s ease;
    }

    .tubo:active { transform: translateY(2px) scale(.98); }

    .tubo::before {
      content: "";
      position: absolute;
      top: -14px;
      left: 50%;
      transform: translateX(-50%);
      width: 44px;
      height: 22px;
      background: #9ca3af;
      border-radius: 999px;
      box-shadow: inset 0 0 0 2px rgba(0,0,0,.25);
      z-index: 2;
    }

    .acqua {
      position: absolute;
      inset: 0;
      background: repeating-linear-gradient(
        180deg,
        rgba(34,211,238,.85) 0%,
        rgba(34,211,238,.85) 10%,
        rgba(56,189,248,.85) 20%,
        rgba(34,211,238,.85) 30%
      );
      opacity: .85;
      transform: translateY(-100%);
      animation: flow 1.2s linear infinite;
    }

    @keyframes flow {
      from { transform: translateY(-100%); }
      to   { transform: translateY(100%); }
    }

    .tubo.selezionato {
      outline: 3px solid var(--accent);
      box-shadow: 0 0 0 6px rgba(34,211,238,.15), 0 10px 30px rgba(34,211,238,.35);
    }

    .shake {
      animation: shake .4s linear;
    }

    @keyframes shake {
      0%,100% { transform: translateX(0); }
      20% { transform: translateX(-8px); }
      40% { transform: translateX(8px); }
      60% { transform: translateX(-6px); }
      80% { transform: translateX(6px); }
    }

    .msg {
      margin-top: 14px;
      min-height: 1.5em;
      font-weight: 600;
    }

    .ok { color: var(--ok); }
    .ko { color: var(--danger); }

    #debugPanel {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      max-height: 35vh;
      overflow: auto;
      background: rgba(2,6,23,.95);
      color: #38bdf8;
      font-size: 12px;
      padding: 6px;
      display: none;
      z-index: 9999;
      text-align: left;
    }

    @media (max-width: 420px) {
      .tubo { width: 56px; height: 170px; }
      .tubi { gap: 14px; }
    }
  </style>
</head>
<body>
  <div class="container" id="app">
    <h1>Labirinto delle Tubature</h1>
    <div class="subtitle">Seleziona la dimensione corretta del tuo personaggio</div>

    <div id="selezionePeso" class="scelte">
      <button onclick="scegliPeso('leggero')">Leggero</button>
      <button onclick="scegliPeso('normale')">Normale</button>
      <button onclick="scegliPeso('pesante')">Pesante</button>
    </div>

    <div id="gioco" style="display:none;">
      <div class="hud">
        <div></div>
        <div>⏳ <span id="timerTxt">15</span>s</div>
      </div>

      <div class="timer-wrap">
        <div class="timer-bar" id="timerBar"></div>
      </div>

      <div class="tubi" id="tubi"></div>
    </div>

    <div class="msg" id="messaggio"></div>
  </div>

  <div id="debugPanel"></div>

  <script>
    const DEBUG = true; // <-- metti false per disattivare debug

    const livelli = [2, 3, 3, 2, 1];
    const combinazioneCorretta = ["sinistra", "centro", "centro", "destra", "centro"];

    let pagina = 0;
    let timer = null;
    let tempoBase = 15;
    let tempo = 15;
    let scelteUtente = [];

    function debugUI(msg) {
      if (!DEBUG) return;
      const panel = document.getElementById("debugPanel");
      panel.style.display = "block";
      const time = new Date().toLocaleTimeString();
      panel.innerHTML += `<div>[${time}] ${msg}</div>`;
      panel.scrollTop = panel.scrollHeight;
      console.log("[DEBUG]", msg);
    }

    function scegliPeso(tipo) {
      if (localStorage.getItem("pesoSelezionato")) {
        debugUI("Peso già selezionato: " + localStorage.getItem("pesoSelezionato"));
        return;
      }

      localStorage.setItem("pesoSelezionato", tipo);
      tempoBase = tipo === "leggero" ? 8 : tipo === "pesante" ? 30 : 15;

      debugUI("Peso scelto: " + tipo + " → tempoBase: " + tempoBase + "s");

      document.getElementById("selezionePeso").style.display = "none";
      document.getElementById("gioco").style.display = "block";
      avviaLivello();
    }

    function avviaLivello() {
      clearInterval(timer);
      document.getElementById("messaggio").innerHTML = "";

      const tubiContainer = document.getElementById("tubi");
      tubiContainer.innerHTML = "";

      const numTubi = livelli[pagina];
      debugUI("Avvio livello " + (pagina + 1) + " con " + numTubi + " tubi");

      for (let i = 0; i < numTubi; i++) {
        const tubo = document.createElement("div");
        tubo.className = "tubo";

        const acqua = document.createElement("div");
        acqua.className = "acqua";
        tubo.appendChild(acqua);

        let posizione = "centro";
        if (numTubi === 2) posizione = i === 0 ? "sinistra" : "destra";
        if (numTubi === 3) posizione = i === 0 ? "sinistra" : i === 1 ? "centro" : "destra";

        tubo.onclick = () => scegliTubo(posizione, tubo);
        tubiContainer.appendChild(tubo);
      }

      tempo = tempoBase;
      aggiornaTimerUI();

      timer = setInterval(() => {
        tempo--;
        aggiornaTimerUI();
        debugUI("Timer: " + tempo + "s");

        if (tempo <= 0) {
          resetGioco("⏱ Tempo scaduto! Torni alla tubatura iniziale.");
        }
      }, 1000);
    }

    function aggiornaTimerUI() {
      document.getElementById("timerTxt").innerText = tempo;
      const perc = (tempo / tempoBase) * 100;
      document.getElementById("timerBar").style.width = perc + "%";
    }

    function scegliTubo(posizione, el) {
      clearInterval(timer);
      el.classList.add("selezionato");
      scelteUtente.push(posizione);
      debugUI("Scelta: " + posizione + " (livello " + (pagina + 1) + ")");
      pagina++;

      setTimeout(() => {
        if (pagina >= livelli.length) {
          controllaRisultato();
        } else {
          avviaLivello();
        }
      }, 300);
    }

    function controllaRisultato() {
      const ok = scelteUtente.every((v, i) => v === combinazioneCorretta[i]);
      debugUI("Scelte utente: " + JSON.stringify(scelteUtente));
      debugUI("Esito finale: " + (ok ? "CORRETTO" : "SBAGLIATO"));

      if (ok) {
        document.getElementById("messaggio").innerHTML =
          "<span class='ok'>✅ Strada corretta! Attendi il master.</span>";
      } else {
        resetGioco("❌ Torni alla tubatura iniziale, combinazione sbagliata!");
      }
    }

    function resetGioco(msg) {
      clearInterval(timer);
      pagina = 0;
      scelteUtente = [];
      debugUI("RESET: " + msg);

      document.getElementById("messaggio").innerHTML =
        "<span class='ko'>" + msg + "</span>";

      document.getElementById("app").classList.add("shake");

      setTimeout(() => {
        document.getElementById("app").classList.remove("shake");
        avviaLivello();
      }, 900);
    }

    window.addEventListener("error", (e) => {
      debugUI("ERRORE JS: " + e.message);
    });
  </script>
</body>
</html>
